<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flight Watch</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:           #0d1117;
      --surface:      #161b27;
      --surface-up:   #1c2336;
      --border:       #252f46;
      --border-hi:    #2e3d58;
      --accent:       #5b8dee;
      --accent-hover: #4a7ce0;
      --accent-glow:  rgba(91, 141, 238, 0.14);
      --text:         #e2eaf8;
      --text-dim:     #7b8eab;   /* lightened from #4e5c75 for readability */
      --text-mid:     #9daec8;
      --mono:         #7ab8f5;
      --user-bg:      #192241;
      --user-border:  #21305c;
      --warn:         #e8973c;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;          /* was 14.5px — better base for readability */
      line-height: 1.72;
    }

    /* ── Shell ── */
    .app {
      display: flex;
      flex-direction: column;
      height: 100dvh;           /* dvh handles mobile browser chrome correctly */
      max-width: 900px;
      margin: 0 auto;
    }

    /* ── Topbar ── */
    .topbar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;          /* allows aircraft field to wrap on mobile */
      gap: 10px 14px;
      padding: 10px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo { line-height: 1.2; }
    .logo-name {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text);
    }
    .logo-sub {
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
      display: block;
    }

    .topbar-divider {
      width: 1px;
      height: 26px;
      background: var(--border-hi);
      flex-shrink: 0;
    }

    /* Aircraft field */
    .acft-wrap {
      position: relative;
      flex: 1;
      min-width: 150px;
      max-width: 280px;
    }
    .acft-tag {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      pointer-events: none;
      z-index: 1;
    }
    #aircraft-input {
      width: 100%;
      background: var(--surface-up);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      padding: 8px 10px 8px 40px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      -webkit-appearance: none;
    }
    #aircraft-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .autocomplete-list {
      position: absolute;
      top: calc(100% + 4px);
      left: 0; right: 0;
      background: var(--surface);
      border: 1px solid var(--border-hi);
      border-radius: 7px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 200;
      display: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.55);
    }
    .autocomplete-list.visible { display: block; }
    .autocomplete-item {
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover,
    .autocomplete-item.selected { background: var(--accent-glow); color: var(--accent); }
    .autocomplete-list::-webkit-scrollbar { width: 3px; }
    .autocomplete-list::-webkit-scrollbar-thumb { background: var(--border-hi); }

    .topbar-spacer { flex: 1; }

    /* Action buttons */
    .topbar-actions { display: flex; gap: 5px; flex-shrink: 0; }
    .btn-action {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-dim);
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      letter-spacing: 0.2px;
      padding: 7px 13px;
      transition: border-color 0.15s, color 0.15s;
      white-space: nowrap;
      min-height: 34px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-action:hover { border-color: var(--border-hi); color: var(--text-mid); }
    .btn-action.new:hover { border-color: var(--warn); color: var(--warn); }
    .btn-icon { font-size: 14px; line-height: 1; }

    /* ── Chat ── */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
      overscroll-behavior: contain;
    }
    .chat-area::-webkit-scrollbar { width: 5px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Messages */
    .message { display: flex; flex-direction: column; max-width: 82%; }
    .message.user    { align-self: flex-end;   align-items: flex-end;   }
    .message.briefer { align-self: flex-start; align-items: flex-start; max-width: 92%; }

    .msg-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 5px;
      padding: 0 3px;
    }

    .msg-bubble {
      padding: 14px 18px;
      border-radius: 12px;
      line-height: 1.72;
      word-break: break-word;
      font-size: 15.5px;       /* slightly larger than base for readability in bubbles */
    }

    .message.user .msg-bubble {
      background: var(--user-bg);
      border: 1px solid var(--user-border);
      border-bottom-right-radius: 4px;
      color: var(--text);
    }

    .message.briefer .msg-bubble {
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    /* Markdown typography — briefer messages */
    .msg-bubble strong { color: var(--accent); font-weight: 600; }
    .msg-bubble em     { color: var(--warn); font-style: normal; }

    .msg-bubble h1, .msg-bubble h2, .msg-bubble h3 {
      color: var(--accent);
      font-weight: 700;
      margin: 16px 0 6px;
      line-height: 1.3;
    }
    .msg-bubble h1 { font-size: 17px; }   /* headers LARGER than body */
    .msg-bubble h2 { font-size: 16px; }
    .msg-bubble h3 { font-size: 15px; }

    .msg-bubble h1:first-child,
    .msg-bubble h2:first-child,
    .msg-bubble h3:first-child { margin-top: 0; }

    .msg-bubble ul, .msg-bubble ol {
      padding-left: 20px;
      margin: 6px 0;
    }
    .msg-bubble li { margin: 4px 0; }
    .msg-bubble p  { margin: 6px 0; }
    .msg-bubble p:first-child { margin-top: 0; }
    .msg-bubble p:last-child  { margin-bottom: 0; }

    .msg-bubble hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0;
    }

    /* Code — most important readability fix */
    .msg-bubble pre {
      background: #080d18;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 14px;
      overflow-x: auto;
      margin: 10px 0;
      -webkit-overflow-scrolling: touch;
    }
    .msg-bubble code {
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Courier New', monospace;
      font-size: 13.5px;       /* was 12px — much more readable */
      color: var(--mono);
      background: rgba(0,0,0,0.28);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .msg-bubble pre code {
      background: none;
      padding: 0;
      font-size: 13px;         /* was 11.5px */
      line-height: 1.6;
    }

    /* Thinking / status indicator */
    .thinking-bubble {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      border-bottom-left-radius: 4px;
      color: var(--text-mid);
      font-size: 14px;
      font-style: italic;
    }
    .thinking-dots { display: flex; gap: 4px; align-items: center; flex-shrink: 0; }
    .thinking-dots span {
      display: inline-block;
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 1.4s ease-in-out infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.5); opacity: 0.25; }
      40%           { transform: scale(1);   opacity: 1; }
    }

    /* ── Status bar ── */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 20px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
      color: var(--text-dim);
      letter-spacing: 0.3px;
      flex-shrink: 0;
    }
    .status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }
    #status-text { color: var(--text-mid); }
    .status-right { margin-left: auto; }

    /* ── Input bar ── */
    .input-bar {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      padding: 14px 20px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    #message-input {
      flex: 1;
      background: var(--surface-up);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: inherit;
      font-size: 16px;       /* 16px prevents iOS auto-zoom on focus */
      line-height: 1.55;
      outline: none;
      padding: 11px 15px;
      resize: none;
      max-height: 140px;
      overflow-y: auto;
      transition: border-color 0.15s, box-shadow 0.15s;
      -webkit-appearance: none;
    }
    #message-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    #message-input::placeholder { color: var(--text-dim); }

    .btn-send {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.2px;
      padding: 11px 24px;
      align-self: flex-end;
      min-height: 44px;       /* proper touch target */
      transition: background 0.15s, transform 0.1s;
      white-space: nowrap;
      -webkit-appearance: none;
    }
    .btn-send:hover  { background: var(--accent-hover); }
    .btn-send:active { transform: scale(0.97); }
    .btn-send:disabled {
      background: var(--border);
      color: var(--text-dim);
      cursor: not-allowed;
    }

    /* ── Mobile ── */
    @media (max-width: 640px) {
      /* Two-row topbar: logo+buttons on top, aircraft field below */
      .topbar {
        padding: 10px 14px 8px;
        column-gap: 10px;
        row-gap: 8px;
      }
      .topbar-divider { display: none; }
      .topbar-spacer  { flex: 1; min-width: 0; }

      .acft-wrap {
        order: 10;              /* push aircraft to second row */
        flex: 0 0 100%;         /* full width */
        max-width: none;
      }

      .logo-sub { display: none; }

      /* Icon-only buttons on mobile — hide text labels */
      .btn-label { display: none; }
      .btn-action {
        padding: 7px 11px;
        min-height: 36px;
      }
      .btn-icon { font-size: 16px; }

      .chat-area { padding: 16px 14px; gap: 16px; }
      .message, .message.briefer { max-width: 97%; }
      .msg-bubble { padding: 12px 14px; font-size: 15px; }

      /* Hide status bar on mobile to save space */
      .status-bar { display: none; }

      .input-bar { padding: 10px 14px 14px; gap: 8px; }
      #message-input { padding: 10px 13px; }
      .btn-send { padding: 10px 18px; }
    }

    /* Landscape phone — keep things compact */
    @media (max-width: 812px) and (orientation: landscape) {
      .topbar { padding: 6px 16px; }
      .chat-area { padding: 12px 16px; }
      .input-bar { padding: 8px 16px 10px; }
    }
  </style>
</head>
<body>
<div class="app">

  <header class="topbar">
    <div class="logo">
      <span class="logo-name">✈ Flight Watch</span>
      <span class="logo-sub">Aviation Weather Briefer</span>
    </div>

    <div class="topbar-divider"></div>

    <div class="acft-wrap">
      <span class="acft-tag">ACFT</span>
      <input
        id="aircraft-input"
        type="text"
        value="2008 Diamond DA40 XLS"
        autocomplete="off"
        spellcheck="false"
        placeholder="Aircraft type…"
      />
      <div class="autocomplete-list" id="autocomplete-list"></div>
    </div>

    <div class="topbar-spacer"></div>

    <div class="topbar-actions">
      <button class="btn-action" id="btn-save-briefing"  title="Save briefing as text file">
        <span class="btn-icon">↓</span><span class="btn-label"> Save</span>
      </button>
      <button class="btn-action" id="btn-copy-briefing"  title="Copy briefing to clipboard">
        <span class="btn-icon">⎘</span><span class="btn-label"> Copy</span>
      </button>
      <button class="btn-action" id="btn-email-briefing" title="Email briefing">
        <span class="btn-icon">✉</span><span class="btn-label"> Email</span>
      </button>
      <button class="btn-action new" id="btn-new-briefing" title="Start new briefing">
        <span class="btn-icon">↺</span><span class="btn-label"> New</span>
      </button>
    </div>
  </header>

  <main class="chat-area" id="chat-area"></main>

  <div class="status-bar">
    <div class="status-dot"></div>
    <span id="status-text">Ready</span>
    <span class="status-right">Not for navigation &nbsp;·&nbsp; aviationweather.gov</span>
  </div>

  <footer class="input-bar">
    <textarea
      id="message-input"
      rows="1"
      placeholder="Provide your flight details, or ask a question…"
      autofocus
    ></textarea>
    <button class="btn-send" id="btn-send">Send</button>
  </footer>
</div>

<script>
  marked.setOptions({ breaks: true, gfm: true });

  let aircraftList   = [];
  let acSelectedIndex = -1;
  let isWaiting      = false;

  const chatArea      = document.getElementById('chat-area');
  const msgInput      = document.getElementById('message-input');
  const btnSend       = document.getElementById('btn-send');
  const aircraftInput = document.getElementById('aircraft-input');
  const autocomplete  = document.getElementById('autocomplete-list');
  const statusText    = document.getElementById('status-text');

  fetch('/aircraft').then(r => r.json()).then(l => { aircraftList = l; }).catch(() => {});

  /* ── Aircraft autocomplete ── */
  aircraftInput.addEventListener('input', () => {
    const q = aircraftInput.value.trim().toLowerCase();
    acSelectedIndex = -1;
    if (!q) { hideAc(); return; }
    const m = aircraftList.filter(a => a.toLowerCase().includes(q)).slice(0, 8);
    if (!m.length) { hideAc(); return; }
    autocomplete.innerHTML = m.map((a, i) =>
      `<div class="autocomplete-item" data-i="${i}">${a}</div>`).join('');
    autocomplete.classList.add('visible');
  });

  aircraftInput.addEventListener('keydown', e => {
    const items = autocomplete.querySelectorAll('.autocomplete-item');
    if (!items.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      acSelectedIndex = Math.min(acSelectedIndex + 1, items.length - 1);
      updateAc(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      acSelectedIndex = Math.max(acSelectedIndex - 1, 0);
      updateAc(items);
    } else if (e.key === 'Enter' && acSelectedIndex >= 0) {
      e.preventDefault();
      aircraftInput.value = items[acSelectedIndex].textContent;
      hideAc();
    } else if (e.key === 'Escape') {
      hideAc();
    }
  });

  autocomplete.addEventListener('mousedown', e => {
    const item = e.target.closest('.autocomplete-item');
    if (item) { aircraftInput.value = item.textContent; hideAc(); }
  });

  document.addEventListener('click', e => {
    if (!aircraftInput.contains(e.target) && !autocomplete.contains(e.target)) hideAc();
  });

  function updateAc(items) {
    items.forEach((el, i) => el.classList.toggle('selected', i === acSelectedIndex));
    if (acSelectedIndex >= 0) items[acSelectedIndex].scrollIntoView({ block: 'nearest' });
  }
  function hideAc() {
    autocomplete.classList.remove('visible');
    autocomplete.innerHTML = '';
    acSelectedIndex = -1;
  }

  /* ── Textarea auto-resize ── */
  msgInput.addEventListener('input', () => {
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 140) + 'px';
  });
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  document.getElementById('btn-send').addEventListener('click', sendMessage);
  document.getElementById('btn-new-briefing').addEventListener('click', newBriefing);
  document.getElementById('btn-save-briefing').addEventListener('click', saveBriefing);
  document.getElementById('btn-copy-briefing').addEventListener('click', copyBriefing);
  document.getElementById('btn-email-briefing').addEventListener('click', emailBriefing);

  /* ── Helpers ── */
  function scrollBottom() {
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function appendMessage(role, text, isMarkdown = false) {
    const wrap   = document.createElement('div');
    wrap.className = `message ${role}`;
    const lbl    = document.createElement('div');
    lbl.className  = 'msg-label';
    lbl.textContent = role === 'user' ? 'Pilot' : 'Flight Watch';
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    if (isMarkdown) bubble.innerHTML = marked.parse(text);
    else bubble.textContent = text;
    wrap.appendChild(lbl);
    wrap.appendChild(bubble);
    chatArea.appendChild(wrap);
    scrollBottom();
    return { wrap, bubble };
  }

  function appendThinking(msg) {
    const wrap   = document.createElement('div');
    wrap.className = 'message briefer';
    const lbl    = document.createElement('div');
    lbl.className  = 'msg-label';
    lbl.textContent = 'Flight Watch';
    const bubble = document.createElement('div');
    bubble.className = 'thinking-bubble';
    bubble.innerHTML = `<span id="think-status">${msg || 'Connecting\u2026'}</span>
      <span class="thinking-dots"><span></span><span></span><span></span></span>`;
    wrap.appendChild(lbl);
    wrap.appendChild(bubble);
    chatArea.appendChild(wrap);
    scrollBottom();
    return wrap;
  }

  /* ── Welcome screen ── */
  function showWelcome() {
    const h = new Date().getHours();
    const t = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
    const msg = `Good ${t}, this is Flight Watch.\n\nTo begin your standard weather briefing, please provide the following:\n\n- **Departure airport** — default KBDR\n- **Destination airport**\n- **Planned departure time** — local or Zulu\n- **Cruise altitude**\n- **Aircraft** — default 2008 Diamond DA40 XLS\n- **Flight rules** — VFR solo, or IFR with instructor\n\nYou may provide all details at once, or I'll ask for each in turn.`;
    appendMessage('briefer', msg, true);
  }

  /* ── Send (streaming) ── */
  async function sendMessage() {
    if (isWaiting) return;
    const text = msgInput.value.trim();
    if (!text) return;

    msgInput.value = '';
    msgInput.style.height = 'auto';
    appendMessage('user', text, false);

    isWaiting = true;
    btnSend.disabled = true;
    statusText.textContent = 'Connecting\u2026';

    const thinkEl      = appendThinking('Connecting\u2026');
    let brieferBubble  = null;
    let fullText       = '';

    try {
      const resp = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message:   text,
          aircraft:  aircraftInput.value.trim(),
          departure: '',
        }),
      });

      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

      const reader  = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer    = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const parts = buffer.split('\n\n');
        buffer = parts.pop();

        for (const part of parts) {
          const line = part.trim();
          if (!line.startsWith('data: ')) continue;
          let data;
          try { data = JSON.parse(line.slice(6)); } catch { continue; }

          if (data.type === 'status') {
            statusText.textContent = data.text;
            const ts = thinkEl.querySelector('#think-status');
            if (ts) ts.textContent = data.text;

          } else if (data.type === 'text') {
            if (thinkEl.parentNode) thinkEl.remove();
            if (!brieferBubble) {
              const wrap     = document.createElement('div');
              wrap.className = 'message briefer';
              const lbl      = document.createElement('div');
              lbl.className  = 'msg-label';
              lbl.textContent = 'Flight Watch';
              brieferBubble  = document.createElement('div');
              brieferBubble.className = 'msg-bubble';
              wrap.appendChild(lbl);
              wrap.appendChild(brieferBubble);
              chatArea.appendChild(wrap);
            }
            fullText += data.text;
            brieferBubble.innerHTML = marked.parse(fullText);
            scrollBottom();

          } else if (data.type === 'done') {
            if (thinkEl.parentNode) thinkEl.remove();
            if (brieferBubble) brieferBubble.innerHTML = marked.parse(fullText);
            statusText.textContent = 'Ready';

          } else if (data.type === 'error') {
            if (thinkEl.parentNode) thinkEl.remove();
            appendMessage('briefer', data.text || 'A system error occurred.', false);
            statusText.textContent = 'Error';
          }
        }
      }
      if (thinkEl.parentNode) thinkEl.remove();

    } catch {
      if (thinkEl.parentNode) thinkEl.remove();
      appendMessage('briefer', 'Communications failure. Please try again.', false);
      statusText.textContent = 'Error';
    } finally {
      isWaiting        = false;
      btnSend.disabled = false;
      msgInput.focus();
    }
  }

  /* ── New briefing ── */
  async function newBriefing() {
    if (isWaiting) return;
    try { await fetch('/reset', { method: 'POST' }); } catch (_) {}
    chatArea.innerHTML = '';
    statusText.textContent = 'Ready';
    showWelcome();
    msgInput.focus();
  }

  /* ── Export helpers ── */
  function buildBriefingText() {
    const msgs = [];
    chatArea.querySelectorAll('.message').forEach(msg => {
      const role = msg.classList.contains('user') ? 'PILOT' : 'FLIGHT WATCH';
      const text = msg.querySelector('.msg-bubble')?.innerText?.trim();
      if (text) msgs.push(`[${role}]\n${text}`);
    });
    if (!msgs.length) return '';
    const sep = '\n\n' + '\u2500'.repeat(60) + '\n\n';
    const hdr = `FLIGHT WATCH WEATHER BRIEFING\n${new Date().toUTCString()}\nAircraft: ${aircraftInput.value || '\u2014'}\n${'═'.repeat(60)}\n\n`;
    return hdr + msgs.join(sep);
  }

  function saveBriefing() {
    const c = buildBriefingText();
    if (!c) return;
    const ts  = new Date().toISOString().slice(0, 16).replace(/[T:]/g, '-');
    const url = URL.createObjectURL(new Blob([c], { type: 'text/plain' }));
    const a   = document.createElement('a');
    a.href = url; a.download = `briefing-${ts}.txt`; a.click();
    URL.revokeObjectURL(url);
  }

  async function copyBriefing() {
    const c   = buildBriefingText();
    if (!c) return;
    const btn = document.getElementById('btn-copy-briefing');
    try {
      await navigator.clipboard.writeText(c);
      btn.innerHTML = '<span class="btn-icon">✓</span><span class="btn-label"> Copied</span>';
    } catch {
      btn.innerHTML = '<span class="btn-icon">✗</span><span class="btn-label"> Failed</span>';
    }
    setTimeout(() => {
      btn.innerHTML = '<span class="btn-icon">⎘</span><span class="btn-label"> Copy</span>';
    }, 2000);
  }

  function emailBriefing() {
    const c = buildBriefingText();
    if (!c) return;
    const body = encodeURIComponent(
      c.length > 1800 ? c.slice(0, 1800) + '\n\n[Truncated \u2014 use Save for full text]' : c
    );
    window.location.href =
      `mailto:?subject=${encodeURIComponent('Flight Watch Weather Briefing')}&body=${body}`;
  }

  /* ── Init ── */
  showWelcome();
</script>
</body>
</html>
