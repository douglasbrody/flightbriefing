<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flight Watch</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:           #0e1118;
      --surface:      #141922;
      --surface-up:   #1b2233;
      --border:       #232d40;
      --border-hi:    #2d3c55;
      --accent:       #4d84e2;
      --accent-hover: #3a72d4;
      --accent-glow:  rgba(77, 132, 226, 0.10);
      --text:         #dde5f4;
      --text-dim:     #4e5c75;
      --text-mid:     #8a9ab8;
      --mono:         #7ab3e8;
      --user-bg:      #182038;
      --user-border:  #1e3060;
      --warn:         #e8923a;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14.5px;
      line-height: 1.6;
    }

    /* ── Shell ── */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 880px;
      margin: 0 auto;
    }

    /* ── Topbar ── */
    .topbar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 22px;
      height: 56px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo { line-height: 1.15; }
    .logo-name {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text);
    }
    .logo-sub {
      font-size: 9px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-dim);
      display: block;
    }

    .topbar-divider {
      width: 1px;
      height: 26px;
      background: var(--border-hi);
    }

    /* Aircraft field */
    .acft-wrap {
      position: relative;
      flex: 1;
      max-width: 280px;
    }
    .acft-tag {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      pointer-events: none;
      z-index: 1;
    }
    #aircraft-input {
      width: 100%;
      background: var(--surface-up);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 12.5px;
      padding: 7px 10px 7px 40px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    #aircraft-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .autocomplete-list {
      position: absolute;
      top: calc(100% + 4px);
      left: 0; right: 0;
      background: var(--surface);
      border: 1px solid var(--border-hi);
      border-radius: 6px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    }
    .autocomplete-list.visible { display: block; }
    .autocomplete-item {
      padding: 8px 12px;
      font-size: 12.5px;
      color: var(--text);
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover,
    .autocomplete-item.selected { background: var(--accent-glow); color: var(--accent); }
    .autocomplete-list::-webkit-scrollbar { width: 3px; }
    .autocomplete-list::-webkit-scrollbar-thumb { background: var(--border); }

    .topbar-spacer { flex: 1; }

    /* Action buttons */
    .topbar-actions { display: flex; gap: 5px; }
    .btn-action {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-dim);
      cursor: pointer;
      font-family: inherit;
      font-size: 11px;
      letter-spacing: 0.3px;
      padding: 5px 11px;
      transition: border-color 0.15s, color 0.15s;
      white-space: nowrap;
    }
    .btn-action:hover { border-color: var(--border-hi); color: var(--text-mid); }
    .btn-action.new:hover { border-color: var(--warn); color: var(--warn); }

    /* ── Chat ── */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      scroll-behavior: smooth;
    }
    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Messages */
    .message { display: flex; flex-direction: column; max-width: 80%; }
    .message.user  { align-self: flex-end;   align-items: flex-end;  }
    .message.briefer { align-self: flex-start; align-items: flex-start; max-width: 90%; }

    .msg-label {
      font-size: 9.5px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 5px;
      padding: 0 2px;
    }

    .msg-bubble {
      padding: 12px 16px;
      border-radius: 10px;
      line-height: 1.65;
      word-break: break-word;
    }

    .message.user .msg-bubble {
      background: var(--user-bg);
      border: 1px solid var(--user-border);
      border-bottom-right-radius: 3px;
      color: var(--text);
    }

    .message.briefer .msg-bubble {
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom-left-radius: 3px;
    }

    /* Markdown */
    .msg-bubble strong { color: var(--accent); font-weight: 600; }
    .msg-bubble em { color: var(--warn); font-style: normal; }
    .msg-bubble h1, .msg-bubble h2, .msg-bubble h3 {
      color: var(--accent);
      font-size: 13.5px;
      font-weight: 600;
      margin: 12px 0 4px;
    }
    .msg-bubble ul, .msg-bubble ol { padding-left: 18px; margin: 6px 0; }
    .msg-bubble li { margin: 3px 0; }
    .msg-bubble p { margin: 5px 0; }
    .msg-bubble p:first-child { margin-top: 0; }
    .msg-bubble p:last-child { margin-bottom: 0; }
    .msg-bubble hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
    .msg-bubble pre {
      background: #080c14;
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 10px 12px;
      overflow-x: auto;
      margin: 8px 0;
    }
    .msg-bubble code {
      font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
      font-size: 12px;
      color: var(--mono);
      background: rgba(0,0,0,0.25);
      padding: 1px 5px;
      border-radius: 3px;
    }
    .msg-bubble pre code {
      background: none;
      padding: 0;
      font-size: 11.5px;
    }

    /* Thinking */
    .thinking-bubble {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      border-bottom-left-radius: 3px;
      color: var(--text-mid);
      font-size: 13px;
      font-style: italic;
    }
    .thinking-dots { display: flex; gap: 4px; align-items: center; }
    .thinking-dots span {
      display: inline-block;
      width: 4px; height: 4px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 1.4s ease-in-out infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.55); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* ── Status bar ── */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 3px 22px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      font-size: 10px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      color: var(--text-dim);
      letter-spacing: 0.4px;
    }
    .status-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }
    #status-text { color: var(--text-mid); }
    .status-right { margin-left: auto; }

    /* ── Input bar ── */
    .input-bar {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      padding: 14px 22px;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }
    #message-input {
      flex: 1;
      background: var(--surface-up);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      outline: none;
      padding: 10px 14px;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    #message-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    #message-input::placeholder { color: var(--text-dim); }

    .btn-send {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding: 10px 22px;
      align-self: flex-end;
      transition: background 0.15s, transform 0.1s;
      white-space: nowrap;
    }
    .btn-send:hover { background: var(--accent-hover); }
    .btn-send:active { transform: scale(0.97); }
    .btn-send:disabled { background: var(--border); color: var(--text-dim); cursor: not-allowed; }

    @media (max-width: 600px) {
      .topbar { padding: 0 14px; }
      .logo-sub { display: none; }
      .chat-area { padding: 16px 14px; }
      .input-bar { padding: 10px 14px; }
      .message, .message.briefer { max-width: 96%; }
    }
  </style>
</head>
<body>
<div class="app">

  <header class="topbar">
    <div class="logo">
      <span class="logo-name">✈ Flight Watch</span>
      <span class="logo-sub">Aviation Weather Briefer</span>
    </div>

    <div class="topbar-divider"></div>

    <div class="acft-wrap">
      <span class="acft-tag">ACFT</span>
      <input
        id="aircraft-input"
        type="text"
        value="2008 Diamond DA40 XLS"
        autocomplete="off"
        spellcheck="false"
        placeholder="Aircraft type…"
      />
      <div class="autocomplete-list" id="autocomplete-list"></div>
    </div>

    <div class="topbar-spacer"></div>

    <div class="topbar-actions">
      <button class="btn-action" id="btn-save-briefing">↓ Save</button>
      <button class="btn-action" id="btn-copy-briefing">⎘ Copy</button>
      <button class="btn-action" id="btn-email-briefing">✉ Email</button>
      <button class="btn-action new" id="btn-new-briefing">↺ New</button>
    </div>
  </header>

  <main class="chat-area" id="chat-area"></main>

  <div class="status-bar">
    <div class="status-dot"></div>
    <span id="status-text">Ready</span>
    <span class="status-right">Not for navigation &nbsp;·&nbsp; aviationweather.gov</span>
  </div>

  <footer class="input-bar">
    <textarea
      id="message-input"
      rows="1"
      placeholder="Provide your flight details, or ask a question…"
      autofocus
    ></textarea>
    <button class="btn-send" id="btn-send">Send</button>
  </footer>
</div>

<script>
  marked.setOptions({ breaks: true, gfm: true });

  let aircraftList = [];
  let acSelectedIndex = -1;
  let isWaiting = false;

  const chatArea      = document.getElementById('chat-area');
  const msgInput      = document.getElementById('message-input');
  const btnSend       = document.getElementById('btn-send');
  const aircraftInput = document.getElementById('aircraft-input');
  const autocomplete  = document.getElementById('autocomplete-list');
  const statusText    = document.getElementById('status-text');

  fetch('/aircraft').then(r => r.json()).then(l => { aircraftList = l; }).catch(() => {});

  /* ── Aircraft autocomplete ── */
  aircraftInput.addEventListener('input', () => {
    const q = aircraftInput.value.trim().toLowerCase();
    acSelectedIndex = -1;
    if (!q) { hideAc(); return; }
    const m = aircraftList.filter(a => a.toLowerCase().includes(q)).slice(0, 8);
    if (!m.length) { hideAc(); return; }
    autocomplete.innerHTML = m.map((a, i) =>
      `<div class="autocomplete-item" data-i="${i}">${a}</div>`).join('');
    autocomplete.classList.add('visible');
  });

  aircraftInput.addEventListener('keydown', e => {
    const items = autocomplete.querySelectorAll('.autocomplete-item');
    if (!items.length) return;
    if (e.key === 'ArrowDown')  { e.preventDefault(); acSelectedIndex = Math.min(acSelectedIndex + 1, items.length - 1); updateAc(items); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); acSelectedIndex = Math.max(acSelectedIndex - 1, 0); updateAc(items); }
    else if (e.key === 'Enter' && acSelectedIndex >= 0) { e.preventDefault(); aircraftInput.value = items[acSelectedIndex].textContent; hideAc(); }
    else if (e.key === 'Escape') hideAc();
  });

  autocomplete.addEventListener('mousedown', e => {
    const item = e.target.closest('.autocomplete-item');
    if (item) { aircraftInput.value = item.textContent; hideAc(); }
  });

  document.addEventListener('click', e => {
    if (!aircraftInput.contains(e.target) && !autocomplete.contains(e.target)) hideAc();
  });

  function updateAc(items) {
    items.forEach((el, i) => el.classList.toggle('selected', i === acSelectedIndex));
    if (acSelectedIndex >= 0) items[acSelectedIndex].scrollIntoView({ block: 'nearest' });
  }
  function hideAc() {
    autocomplete.classList.remove('visible');
    autocomplete.innerHTML = '';
    acSelectedIndex = -1;
  }

  /* ── Textarea resize ── */
  msgInput.addEventListener('input', () => {
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
  });
  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  document.getElementById('btn-send').addEventListener('click', sendMessage);
  document.getElementById('btn-new-briefing').addEventListener('click', newBriefing);
  document.getElementById('btn-save-briefing').addEventListener('click', saveBriefing);
  document.getElementById('btn-copy-briefing').addEventListener('click', copyBriefing);
  document.getElementById('btn-email-briefing').addEventListener('click', emailBriefing);

  /* ── Helpers ── */
  function scrollBottom() { chatArea.scrollTop = chatArea.scrollHeight; }

  function appendMessage(role, text, isMarkdown = false) {
    const wrap = document.createElement('div');
    wrap.className = `message ${role}`;
    const lbl = document.createElement('div');
    lbl.className = 'msg-label';
    lbl.textContent = role === 'user' ? 'Pilot' : 'Flight Watch';
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    if (isMarkdown) bubble.innerHTML = marked.parse(text);
    else bubble.textContent = text;
    wrap.appendChild(lbl);
    wrap.appendChild(bubble);
    chatArea.appendChild(wrap);
    scrollBottom();
  }

  function appendThinking(msg) {
    const wrap = document.createElement('div');
    wrap.className = 'message briefer';
    const lbl = document.createElement('div');
    lbl.className = 'msg-label';
    lbl.textContent = 'Flight Watch';
    const bubble = document.createElement('div');
    bubble.className = 'thinking-bubble';
    bubble.innerHTML = `<span id="think-status">${msg || 'Connecting\u2026'}</span>
      <span class="thinking-dots"><span></span><span></span><span></span></span>`;
    wrap.appendChild(lbl);
    wrap.appendChild(bubble);
    chatArea.appendChild(wrap);
    scrollBottom();
    return wrap;
  }

  /* ── Welcome ── */
  function showWelcome() {
    const h = new Date().getHours();
    const t = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
    const msg = `Good ${t}, this is Flight Watch.\n\nTo begin your standard weather briefing, please provide the following:\n\n- **Departure airport** — default KBDR\n- **Destination airport**\n- **Planned departure time** — local or Zulu\n- **Cruise altitude**\n- **Aircraft** — default 2008 Diamond DA40 XLS\n- **Flight rules** — VFR solo, or IFR with instructor\n\nYou may provide all details at once, or I'll ask for each in turn.`;
    appendMessage('briefer', msg, true);
  }

  /* ── Send (streaming) ── */
  async function sendMessage() {
    if (isWaiting) return;
    const text = msgInput.value.trim();
    if (!text) return;

    msgInput.value = '';
    msgInput.style.height = 'auto';
    appendMessage('user', text, false);

    isWaiting = true;
    btnSend.disabled = true;
    statusText.textContent = 'Connecting…';

    const thinkEl = appendThinking('Connecting\u2026');
    let brieferBubble = null;
    let fullText = '';

    try {
      const resp = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: text,
          aircraft: aircraftInput.value.trim(),
          departure: '',
        }),
      });

      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const parts = buffer.split('\n\n');
        buffer = parts.pop();

        for (const part of parts) {
          const line = part.trim();
          if (!line.startsWith('data: ')) continue;
          let data;
          try { data = JSON.parse(line.slice(6)); } catch { continue; }

          if (data.type === 'status') {
            statusText.textContent = data.text;
            const ts = thinkEl.querySelector('#think-status');
            if (ts) ts.textContent = data.text;

          } else if (data.type === 'text') {
            if (thinkEl.parentNode) thinkEl.remove();
            if (!brieferBubble) {
              const wrap = document.createElement('div');
              wrap.className = 'message briefer';
              const lbl = document.createElement('div');
              lbl.className = 'msg-label';
              lbl.textContent = 'Flight Watch';
              brieferBubble = document.createElement('div');
              brieferBubble.className = 'msg-bubble';
              wrap.appendChild(lbl);
              wrap.appendChild(brieferBubble);
              chatArea.appendChild(wrap);
            }
            fullText += data.text;
            brieferBubble.innerHTML = marked.parse(fullText);
            scrollBottom();

          } else if (data.type === 'done') {
            if (thinkEl.parentNode) thinkEl.remove();
            if (brieferBubble) brieferBubble.innerHTML = marked.parse(fullText);
            statusText.textContent = 'Ready';

          } else if (data.type === 'error') {
            if (thinkEl.parentNode) thinkEl.remove();
            appendMessage('briefer', data.text || 'A system error occurred.', false);
            statusText.textContent = 'Error';
          }
        }
      }
      if (thinkEl.parentNode) thinkEl.remove();

    } catch {
      if (thinkEl.parentNode) thinkEl.remove();
      appendMessage('briefer', 'Communications failure. Please try again.', false);
      statusText.textContent = 'Error';
    } finally {
      isWaiting = false;
      btnSend.disabled = false;
      msgInput.focus();
    }
  }

  /* ── New briefing ── */
  async function newBriefing() {
    if (isWaiting) return;
    try { await fetch('/reset', { method: 'POST' }); } catch (_) {}
    chatArea.innerHTML = '';
    statusText.textContent = 'Ready';
    showWelcome();
    msgInput.focus();
  }

  /* ── Export helpers ── */
  function buildBriefingText() {
    const msgs = [];
    chatArea.querySelectorAll('.message').forEach(msg => {
      const role = msg.classList.contains('user') ? 'PILOT' : 'FLIGHT WATCH';
      const text = msg.querySelector('.msg-bubble')?.innerText?.trim();
      if (text) msgs.push(`[${role}]\n${text}`);
    });
    if (!msgs.length) return '';
    const sep = '\n\n' + '─'.repeat(60) + '\n\n';
    const hdr = `FLIGHT WATCH WEATHER BRIEFING\n${new Date().toUTCString()}\nAircraft: ${aircraftInput.value || '—'}\n${'═'.repeat(60)}\n\n`;
    return hdr + msgs.join(sep);
  }

  function saveBriefing() {
    const c = buildBriefingText();
    if (!c) return;
    const ts = new Date().toISOString().slice(0, 16).replace(/[T:]/g, '-');
    const url = URL.createObjectURL(new Blob([c], { type: 'text/plain' }));
    const a = document.createElement('a');
    a.href = url; a.download = `briefing-${ts}.txt`; a.click();
    URL.revokeObjectURL(url);
  }

  async function copyBriefing() {
    const c = buildBriefingText();
    if (!c) return;
    const btn = document.getElementById('btn-copy-briefing');
    try {
      await navigator.clipboard.writeText(c);
      btn.textContent = '✓ Copied';
    } catch {
      btn.textContent = '✗ Failed';
    }
    setTimeout(() => { btn.textContent = '⎘ Copy'; }, 2000);
  }

  function emailBriefing() {
    const c = buildBriefingText();
    if (!c) return;
    const body = encodeURIComponent(c.length > 1800 ? c.slice(0, 1800) + '\n\n[Truncated — use Save for full text]' : c);
    window.location.href = `mailto:?subject=${encodeURIComponent('Flight Watch Weather Briefing')}&body=${body}`;
  }

  /* ── Init ── */
  showWelcome();
</script>
</body>
</html>
